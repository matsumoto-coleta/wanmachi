# 要件定義書

## プロジェクト概要

### アプリケーション名
Wanmachi（わんまち）

### 技術スタック
- **フロントエンド**: Next.js 14 (App Router, SSR)
- **バックエンド**: Supabase
- **データベース**: PostgreSQL (Supabase)
- **認証**: Supabase Auth
- **デプロイ**: Vercel（フロントエンド）、Supabase（バックエンド）

## 機能要件

### 基本機能
- [ ] ユーザー登録・ログイン機能
- [ ] ユーザープロフィール管理
- [ ] ダッシュボード画面
- [ ] レスポンシブデザイン対応

### 認証機能
- [ ] メールアドレス/パスワード認証
- [ ] パスワードリセット機能
- [ ] セッション管理

#### Supabase認証実装詳細
- **参考ドキュメント**: [Supabase Auth with Next.js](https://supabase.com/docs/guides/auth/server-side/nextjs)
- **必要パッケージ**: `@supabase/supabase-js`, `@supabase/ssr`
- **実装アーキテクチャ**:
  - クライアントコンポーネント用Supabaseクライアント
  - サーバーコンポーネント用Supabaseクライアント
  - ミドルウェアによる認証トークンの管理
  - Server Actionsを使用したサーバーサイド認証処理
- **セキュリティ考慮事項**:
  - サーバーコードでは`getUser()`を使用（`getSession()`は信頼しない）
  - 各ルートで新しいSupabaseクライアントを作成
  - 適切なトークンリフレッシュ機能の実装
- **メール確認機能**:
  - Supabaseダッシュボードでのメールテンプレート設定
  - メール確認用のルートハンドラー実装

### データ管理
- [ ] ユーザーデータの永続化
- [ ] データのCRUD操作
- [ ] リアルタイム更新対応

## 非機能要件

### パフォーマンス
- [ ] 初期表示時間: 3秒以内
- [ ] SSRによるSEO最適化
- [ ] 画像最適化対応

### セキュリティ
- [ ] HTTPS通信の強制
- [ ] SQLインジェクション対策
- [ ] XSS対策
- [ ] CSRF対策
- [ ] 適切な認証・認可

### 可用性
- [ ] 99.9%以上の稼働率
- [ ] 自動バックアップ機能
- [ ] エラーハンドリング

## 技術的制約

### フロントエンド（Next.js）
- App Routerを使用
- Server Side Rendering (SSR) を活用
- TypeScriptを使用
- ESLint、Prettierによるコード品質管理

### バックエンド（Supabase）
- Row Level Security (RLS) の実装
- Database Functions の活用
- Real-time subscriptions の活用
- Edge Functions の利用検討

## 画面構成

### 認証関連
- [ ] ログイン画面
- [ ] ユーザー登録画面
- [ ] パスワードリセット画面

### メイン機能
- [ ] ダッシュボード
- [ ] プロフィール設定画面

## データベース設計

### 主要テーブル
- `users`: ユーザー情報
- `profiles`: ユーザープロフィール
- その他必要に応じて追加

## 開発環境

### 必要なツール
- Node.js (v18以上)
- npm または yarn
- Git
- VS Code (推奨)

### 環境変数
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`

## デプロイメント

### 本番環境
- フロントエンド: Vercel
- バックエンド: Supabase
- ドメイン: TBD

### CI/CD
- GitHub Actions による自動デプロイ
- テスト自動実行
- コード品質チェック

## マイルストーン

### Phase 1: 基盤構築
- [ ] Next.js プロジェクトのセットアップ
- [ ] Supabase プロジェクトの作成
- [ ] 基本的な認証機能の実装

### Phase 2: 基本機能実装
- [ ] ユーザープロフィール機能
- [ ] ダッシュボード機能
- [ ] データベース設計・実装

### Phase 3: 本格運用準備
- [ ] テスト実装
- [ ] パフォーマンス最適化
- [ ] セキュリティ強化
- [ ] デプロイメント設定

## 注意事項

- このプロジェクトは初期段階であり、要件は開発過程で調整される可能性があります
- セキュリティ要件については特に注意深く実装する必要があります
- パフォーマンスとユーザビリティを両立させることを重視します

## 今後の拡張予定

- PWA対応
- 多言語対応
- API の外部公開
- 管理者機能
- 分析・レポート機能